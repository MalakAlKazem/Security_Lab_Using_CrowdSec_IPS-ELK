services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.2
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
    ports:
      - "9200:9200"
    volumes:
      - es-data:/usr/share/elasticsearch/data
    networks: [elk]

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - xpack.security.enabled=false
    ports:
      - "5601:5601"
    depends_on: [elasticsearch]
    networks: [elk]

  logstash:
    image: docker.elastic.co/logstash/logstash:8.12.2
    environment:
      - ELASTIC_HOST=http://elasticsearch:9200
      - CROWDSEC_BOUNCER_KEY=${CROWDSEC_BOUNCER_KEY}
    volumes:
      - ./logstash/pipeline:/usr/share/logstash/pipeline:ro
    ports:
      - "5044:5044"
    depends_on: [elasticsearch]
    networks: [elk, sec]

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.12.2
    user: root
    command: ["--strict.perms=false"]
    volumes:
      - ./filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - openresty-logs:/var/log/nginx:ro
    depends_on: [logstash]
    networks: [elk, sec]

  crowdsec:
    image: crowdsecurity/crowdsec:latest
    environment:
      # Install parsers/scenarios bundles (collections) at startup :contentReference[oaicite:4]{index=4}
      - COLLECTIONS=crowdsecurity/nginx crowdsecurity/http-cve
      # Auto-register the bouncer key in the CrowdSec container :contentReference[oaicite:5]{index=5}
      - BOUNCER_KEY_openresty=${CROWDSEC_BOUNCER_KEY}
      # Disable default private IP whitelist for testing
      - DISABLE_PARSERS=crowdsecurity/whitelists
    volumes:
      - crowdsec-data:/var/lib/crowdsec/data
      - ./crowdsec/acquis.yaml:/etc/crowdsec/acquis.yaml:ro
      - ./crowdsec/scenarios/custom-http-404-flood.yaml:/etc/crowdsec/scenarios/custom-http-404-flood.yaml:ro
      - ./crowdsec/scenarios/custom-http-post-flood.yaml:/etc/crowdsec/scenarios/custom-http-post-flood.yaml:ro
      - ./crowdsec/scenarios/custom-login-bruteforce.yaml:/etc/crowdsec/scenarios/custom-login-bruteforce.yaml:ro
      - ./crowdsec/scenarios/custom-scanner-detection.yaml:/etc/crowdsec/scenarios/custom-scanner-detection.yaml:ro
      - ./crowdsec/scenarios/custom-sensitive-files.yaml:/etc/crowdsec/scenarios/custom-sensitive-files.yaml:ro
      - ./crowdsec/scenarios/custom-http-method-abuse.yaml:/etc/crowdsec/scenarios/custom-http-method-abuse.yaml:ro
      - ./crowdsec/scenarios/custom-sql-injection.yaml:/etc/crowdsec/scenarios/custom-sql-injection.yaml:ro
      - ./crowdsec/parsers/custom-whitelist.yaml:/etc/crowdsec/parsers/s02-enrich/custom-whitelist.yaml:ro
      - openresty-logs:/var/log/nginx:ro
    ports:
      - "8080:8080"  # CrowdSec Local API (optional to expose; useful for debugging)
    networks: [sec]

  openresty:
    image: crowdsecurity/openresty:latest
    ports:
      - "8088:80"   # Public entry point
    environment:
      - TZ=Asia/Beirut
      - API_URL=http://crowdsec:8080
      - API_KEY=${CROWDSEC_BOUNCER_KEY}
      - BOUNCING_ON_TYPE=all
      - FALLBACK_REMEDIATION=ban
      - MODE=stream
      - UPDATE_FREQUENCY=5
      - CACHE_EXPIRATION=1
      - REQUEST_TIMEOUT=2000
    volumes:
      - ./openresty/nginx.conf:/usr/local/openresty/nginx/conf/nginx.conf:ro
      - ./openresty/conf.d/crowdsec_openresty.conf:/usr/local/openresty/nginx/conf/conf.d/crowdsec_openresty.conf:ro
      - openresty-logs:/var/log/nginx
    depends_on: [crowdsec, web]
    networks: [sec]

  web:
    image: nginx:alpine
    volumes:
      - ./web/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./web/html:/usr/share/nginx/html:ro
    networks: [sec]

  attacker:
    image: kalilinux/kali-rolling:latest
    command: ["bash", "-lc", "sleep infinity"]
    volumes:
      - ./scripts:/scripts:ro
    networks: [sec]

volumes:
  es-data:
  crowdsec-data:
  openresty-logs:

networks:
  elk:
  sec:
